<html>
    <head>
        <title>call your loved ones</title>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <script src="https://unpkg.com/htmx.org@2.0.4"></script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style type="text/tailwindcss">
            @theme {
                --color-warm-950: #232220;
                --color-warm-800: #4e4c4f;
                --color-warm-500: #9f8d8d;
                --color-warm-400: #c4b5a8;
                --color-warm-300: #d9ae8e;
                --color-warm-100: #ffddba;
                --color-warm-50: #fff5e6;
                --color-matte-red: #8b5a5a;
            }
        </style>
        <script>
            const STORAGE_KEY = 'loved_ones';
            const TOKEN_KEY = 'auth_token';

            function getToken() {
                return localStorage.getItem(TOKEN_KEY);
            }

            function setToken(token) {
                localStorage.setItem(TOKEN_KEY, token);
            }

            function clearToken() {
                localStorage.removeItem(TOKEN_KEY);
            }

            function isLoggedIn() {
                return !!getToken();
            }

            function formatDate(dateStr) {
                if (!dateStr) return 'never';
                const date = new Date(dateStr);
                return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
            }

            function getLovedOnesFromStorage() {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            }

            function saveLovedOnesToStorage(lovedOnes) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(lovedOnes));
            }

            function sortLovedOnes(lovedOnes) {
                return lovedOnes.sort((a, b) => {
                    const aLastCalled = a.last_called_at ? new Date(a.last_called_at).getTime() : null;
                    const bLastCalled = b.last_called_at ? new Date(b.last_called_at).getTime() : null;
                    const aCreated = new Date(a.created_at).getTime();
                    const bCreated = new Date(b.created_at).getTime();

                    if (aLastCalled === null && bLastCalled === null) {
                        return bCreated - aCreated;
                    }
                    if (aLastCalled === null) return -1;
                    if (bLastCalled === null) return 1;
                    return aLastCalled - bLastCalled;
                });
            }

            async function apiRequest(url, options = {}) {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                };

                const response = await fetch(url, { ...options, headers });
                if (response.status === 401) {
                    clearToken();
                    window.location.reload();
                }
                return response;
            }

            async function getLovedOnesFromAPI() {
                const response = await apiRequest('/api/loved_ones');
                return await response.json();
            }

            async function addLovedOneAPI(name) {
                const response = await apiRequest('/api/loved_ones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(name)}`
                });
                return await response.json();
            }

            async function markCalledAPI(name) {
                const response = await apiRequest(`/api/loved_ones/${encodeURIComponent(name)}/called`, {
                    method: 'POST'
                });
                return await response.json();
            }

            async function deleteLovedOneAPI(name) {
                await apiRequest(`/api/loved_ones/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
            }

            function renderLovedOnes(lovedOnes) {
                const container = document.getElementById('loved_ones-list');
                if (!lovedOnes || lovedOnes.length === 0) {
                    container.innerHTML = '<p class="text-warm-500 text-center py-8 col-span-full">but nobody is yet. change that :)</p>';
                    return;
                }

                const sorted = sortLovedOnes([...lovedOnes]);
                container.innerHTML = sorted.map(lo => `
                    <div class="bg-warm-800 border border-warm-500/30 rounded-xl p-5 flex flex-col">
                        <span class="font-medium text-warm-50 text-lg mb-1">${lo.name}</span>
                        <span class="text-warm-300 text-sm mb-4">last called: ${formatDate(lo.last_called_at)}</span>
                        <div class="flex gap-2 mt-auto justify-end">
                            <button
                                onclick="markCalled('${lo.name.replace(/'/g, "\\'")}')"
                                class="bg-warm-300 text-warm-950 px-4 py-1.5 rounded-md text-sm font-medium hover:bg-warm-100 transition-colors cursor-pointer"
                            >
                                called
                            </button>
                            <button
                                onclick="deleteLo('${lo.name.replace(/'/g, "\\'")}')"
                                class="bg-warm-800 text-warm-400 px-3 py-1.5 rounded-md text-sm font-medium border border-warm-500/50 hover:bg-matte-red hover:text-warm-50 hover:border-matte-red transition-colors cursor-pointer"
                            >
                                delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            async function loadLovedOnes() {
                if (isLoggedIn()) {
                    const lovedOnes = await getLovedOnesFromAPI();
                    renderLovedOnes(lovedOnes);
                } else {
                    const lovedOnes = getLovedOnesFromStorage();
                    renderLovedOnes(lovedOnes);
                }
            }

            async function addLovedOne(name) {
                if (!name) return;

                if (isLoggedIn()) {
                    await addLovedOneAPI(name);
                    await loadLovedOnes();
                } else {
                    const lovedOnes = getLovedOnesFromStorage();
                    lovedOnes.push({
                        name,
                        last_called_at: null,
                        created_at: new Date().toISOString()
                    });
                    saveLovedOnesToStorage(lovedOnes);
                    renderLovedOnes(lovedOnes);
                }
            }

            async function markCalled(name) {
                if (isLoggedIn()) {
                    await markCalledAPI(name);
                    await loadLovedOnes();
                } else {
                    const lovedOnes = getLovedOnesFromStorage();
                    const lo = lovedOnes.find(l => l.name === name);
                    if (lo) {
                        lo.last_called_at = new Date().toISOString();
                        saveLovedOnesToStorage(lovedOnes);
                        renderLovedOnes(lovedOnes);
                    }
                }
            }

            async function deleteLo(name) {
                if (isLoggedIn()) {
                    await deleteLovedOneAPI(name);
                    await loadLovedOnes();
                } else {
                    let lovedOnes = getLovedOnesFromStorage();
                    lovedOnes = lovedOnes.filter(l => l.name !== name);
                    saveLovedOnesToStorage(lovedOnes);
                    renderLovedOnes(lovedOnes);
                }
            }

            async function login(username, password) {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    setToken(data.access_token);
                    window.location.reload();
                } else {
                    throw new Error('Invalid credentials');
                }
            }

            async function register(username, password) {
                // Get loved ones from local storage to migrate them
                const lovedOnes = getLovedOnesFromStorage();

                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        loved_ones: lovedOnes
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    setToken(data.access_token);
                    // Clear local storage since we've migrated to the server
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                } else {
                    throw new Error('Registration failed');
                }
            }

            function logout() {
                clearToken();
                window.location.reload();
            }

            function showAuthModal() {
                document.getElementById('auth-modal').classList.remove('hidden');
            }

            function hideAuthModal() {
                document.getElementById('auth-modal').classList.add('hidden');
            }

            function showLogin() {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }

            function showRegister() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }

            document.addEventListener('DOMContentLoaded', async () => {
                await loadLovedOnes();

                const authBtn = document.getElementById('auth-btn');
                const userInfo = document.getElementById('user-info');
                if (isLoggedIn()) {
                    authBtn.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                } else {
                    authBtn.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                }

                document.getElementById('add-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = e.target.elements.name.value;
                    await addLovedOne(name);
                    e.target.reset();
                });

                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = e.target.elements['login-username'].value;
                    const password = e.target.elements['login-password'].value;
                    try {
                        await login(username, password);
                    } catch (err) {
                        alert(err.message);
                    }
                });

                document.getElementById('register-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = e.target.elements['register-username'].value;
                    const password = e.target.elements['register-password'].value;
                    try {
                        await register(username, password);
                    } catch (err) {
                        alert(err.message);
                    }
                });
            });
        </script>
    </head>
    <body class="bg-warm-950 min-h-screen p-4 sm:p-8 lowercase">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-warm-100 tracking-wide">lots of people want to hear from you</h1>

                <div class="flex gap-3 w-full sm:w-auto shrink-0 items-center">
                    <form id="add-form" class="flex gap-3 flex-1 sm:flex-initial">
                        <input
                            type="text"
                            name="name"
                            placeholder="name"
                            autocomplete="off"
                            data-1p-ignore
                            data-lpignore="true"
                            class="bg-warm-800 border border-warm-500 rounded-lg px-4 py-2 text-warm-100 placeholder-warm-500 focus:outline-none focus:border-warm-300 transition-colors flex-1 sm:w-48"
                            required
                        />
                        <button
                            type="submit"
                            class="bg-warm-300 text-warm-950 px-5 py-2 rounded-lg font-medium hover:bg-warm-100 transition-colors cursor-pointer"
                        >
                            add
                        </button>
                    </form>

                    <button
                        id="auth-btn"
                        onclick="showAuthModal()"
                        class="bg-warm-800 text-warm-100 px-4 py-2 rounded-lg font-medium border border-warm-500 hover:bg-warm-700 transition-colors cursor-pointer hidden"
                    >
                        login
                    </button>

                    <button
                        id="user-info"
                        onclick="logout()"
                        class="bg-warm-800 text-warm-100 px-4 py-2 rounded-lg font-medium border border-warm-500 hover:bg-warm-700 transition-colors cursor-pointer hidden"
                    >
                        log out
                    </button>
                </div>
            </div>

            <div id="loved_ones-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            </div>
        </div>

        <div id="auth-modal" class="hidden fixed inset-0 backdrop-blur-sm bg-black/20 flex items-center justify-center p-4 z-50">
            <div class="bg-warm-800 rounded-xl p-8 max-w-md w-full">
                <form id="login-form" class="space-y-4">
                    <h2 class="text-2xl font-bold text-warm-100 mb-4">login</h2>
                    <input
                        type="text"
                        name="login-username"
                        placeholder="username"
                        required
                        class="w-full bg-warm-950 border border-warm-500 rounded-lg px-4 py-2 text-warm-100 placeholder-warm-500 focus:outline-none focus:border-warm-300 transition-colors"
                    />
                    <input
                        type="password"
                        name="login-password"
                        placeholder="password"
                        required
                        class="w-full bg-warm-950 border border-warm-500 rounded-lg px-4 py-2 text-warm-100 placeholder-warm-500 focus:outline-none focus:border-warm-300 transition-colors"
                    />
                    <div class="flex gap-3">
                        <button
                            type="submit"
                            class="flex-1 bg-warm-300 text-warm-950 px-5 py-2 rounded-lg font-medium hover:bg-warm-100 transition-colors cursor-pointer"
                        >
                            login
                        </button>
                        <button
                            type="button"
                            onclick="hideAuthModal()"
                            class="bg-warm-700 text-warm-100 px-5 py-2 rounded-lg font-medium hover:bg-warm-600 transition-colors cursor-pointer"
                        >
                            cancel
                        </button>
                    </div>
                    <p class="text-warm-400 text-sm text-center">
                        don't have an account?
                        <button type="button" onclick="showRegister()" class="text-warm-300 hover:text-warm-100 underline">sign up</button>
                    </p>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <h2 class="text-2xl font-bold text-warm-100 mb-4">sign up</h2>
                    <input
                        type="text"
                        name="register-username"
                        placeholder="username"
                        required
                        class="w-full bg-warm-950 border border-warm-500 rounded-lg px-4 py-2 text-warm-100 placeholder-warm-500 focus:outline-none focus:border-warm-300 transition-colors"
                    />
                    <input
                        type="password"
                        name="register-password"
                        placeholder="password"
                        required
                        class="w-full bg-warm-950 border border-warm-500 rounded-lg px-4 py-2 text-warm-100 placeholder-warm-500 focus:outline-none focus:border-warm-300 transition-colors"
                    />
                    <div class="flex gap-3">
                        <button
                            type="submit"
                            class="flex-1 bg-warm-300 text-warm-950 px-5 py-2 rounded-lg font-medium hover:bg-warm-100 transition-colors cursor-pointer"
                        >
                            sign up
                        </button>
                        <button
                            type="button"
                            onclick="hideAuthModal()"
                            class="bg-warm-700 text-warm-100 px-5 py-2 rounded-lg font-medium hover:bg-warm-600 transition-colors cursor-pointer"
                        >
                            cancel
                        </button>
                    </div>
                    <p class="text-warm-400 text-sm text-center">
                        already have an account?
                        <button type="button" onclick="showLogin()" class="text-warm-300 hover:text-warm-100 underline">login</button>
                    </p>
                </form>
            </div>
        </div>
    </body>
</html>
